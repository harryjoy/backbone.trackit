//
// backbone.trackit - Master
// The MIT License
// Copyright (c) 2013 The New York Times, CMS Group, Matthew DeLambo <delambo@gmail.com> 
//
!function(a,b){"object"==typeof exports?module.exports=b(require("backbone"),require("underscore")):"function"==typeof define&&define.amd?define(["backbone","underscore"],function(a,c){return b(a,c)}):b(Backbone,_)}(this,function(a,b){if(!a)throw new Error("backbone.trackit requires Backbone.");if(!b)throw new Error("backbone.trackit requires underscore.");var c=[],d=function(a){b.isEmpty(a._unsavedChanges)?c=b.filter(c,function(b){return a.cid!=b.cid}):b.findWhere(c,{cid:a.cid})||c.push(a)},e=function(a){var d,e=b.rest(arguments),f=function(a,c){return b.isBoolean(c)?c:(b.isString(c)?a[c]:c).apply(a,e)};return b.each(c,function(b){!d&&f(b,b._unsavedConfig[a])&&(d=b._unsavedConfig.prompt)}),d};a.History.prototype.loadUrl=b.wrap(a.History.prototype.loadUrl,function(b,c,d){var f=e("unloadRouterPrompt",c,d);f?a.Events.trigger("prompt:modelchanges",[this,b,c,d]):b.call(this,c,d)}),window.onbeforeunload=function(a){return e("unloadWindowPrompt",a)},b.extend(a.Model.prototype,{unsaved:{},_trackingChanges:!1,_originalAttrs:{},_unsavedChanges:{},startTracking:function(){return this._unsavedConfig=b.extend({},{prompt:"You have unsaved changes!",unloadRouterPrompt:!1,unloadWindowPrompt:!1},this.unsaved||{}),this._trackingChanges=!0,this._resetTracking(),this._triggerUnsavedChanges(),this},stopTracking:function(){return this._trackingChanges=!1,this._originalAttrs={},this._unsavedChanges={},this._triggerUnsavedChanges(),this},restartTracking:function(){return this._resetTracking(),this._triggerUnsavedChanges(),this},resetAttributes:function(){return this._trackingChanges?(this.attributes=this._originalAttrs,this._resetTracking(),this._triggerUnsavedChanges(),this):void 0},unsavedAttributes:function(a){if(!a)return b.isEmpty(this._unsavedChanges)?!1:b.clone(this._unsavedChanges);var c,d=!1,e=this._unsavedChanges;for(var f in a)b.isEqual(e[f],c=a[f])||((d||(d={}))[f]=c);return d},_resetTracking:function(){this._originalAttrs=b.clone(this.attributes),this._unsavedChanges={}},_triggerUnsavedChanges:function(){this.trigger("unsavedChanges",!b.isEmpty(this._unsavedChanges),b.clone(this._unsavedChanges),this),this.unsaved&&d(this)}}),a.Model.prototype.set=b.wrap(a.Model.prototype.set,function(a,c,d,e){var f,g;return null==c?this:("object"==typeof c?(f=c,e=d):(f={})[c]=d,e||(e={}),g=a.call(this,f,e),!this._trackingChanges||e.silent||e.trackit_silent||(b.each(f,b.bind(function(a,c){b.isEqual(this._originalAttrs[c],a)?delete this._unsavedChanges[c]:this._unsavedChanges[c]=a},this)),this._triggerUnsavedChanges()),g)}),a.sync=b.wrap(a.sync,function(a,c,d,e){return e||(e={}),("update"==c||"create"==c||"patch"==c)&&(e.success=b.wrap(e.success,b.bind(function(a,b,c,e){var f;return a&&(f=a.call(this,b,c,e)),d._trackingChanges&&(d._resetTracking(),d._triggerUnsavedChanges()),f},this))),a(c,d,e)})});